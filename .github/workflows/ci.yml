name: CI

on:
  push:
    branches:
      - main
    tags-ignore:
      - v*
      
env:
  GITHUB_TOKEN: ${{ github.token }}
  
jobs:
    nightly:
        name: Nightly
        runs-on: windows-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v3.0.2
              with:
                submodules: 'false'
                fetch-depth: 0
            - name: Git Semantic Version
              id: versioning
              uses: PaulHatch/semantic-version@v5.0.0-alpha2
              with:
                branch: main
                tag_prefix: "v"
                major_pattern: "/BREAKING CHANGE:|ðŸ’¥/"
                major_regexp_flags: "s"
                minor_pattern: "/feat:|âœ¨/"
                minor_regexp_flags: "s"
                format: "${major}.${minor}.${patch}-prerelease${increment}"
            - name: Bump version in manifest.json
              uses: jossef/action-set-json-field@v2
              with:
                file: src/manifest.json
                field: version
                value: ${{ steps.versioning.outputs.version }}
            - name: Commit manifest.json
              run: |
                git config --local user.email "action@github.com"
                git config --local user.name "GitHub Action"
                git add -A
                git commit -m "ðŸ”– bump version to ${{ steps.versioning.outputs.version }}"
            - name: Push changes to manifest.json
              uses: ad-m/github-push-action@v0.6.0
              with:
                github_token: ${{ github.token }}
                branch: ${{ github.ref }}
                tags: ${{ env.REPO }}:latest,${{ env.REPO }}:v${{ steps.versioning.outputs.version }}
                
            - name: Create Release
              if: ${{ !startsWith(github.ref, 'refs/tags/') }}
              uses: actions/create-release@1
              with:
                tag_name: v${{ steps.versioning.outputs.version }}
                release_name: v${{ steps.versioning.outputs.version }}
                prerelease: true
