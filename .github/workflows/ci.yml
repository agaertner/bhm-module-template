name: CI

on:
  push:
    branches:
      - main
    tags-ignore:
      - v*
      
env:
  GITHUB_TOKEN: ${{ github.token }}
  
jobs:
    nightly:
        name: Nightly
        runs-on: windows-latest
        steps:
            - name: Install GitVersion
              uses: gittools/actions/gitversion/setup@v0.9.7
              with:
                versionSpec: '5.x'

            - name: Checkout
              uses: actions/checkout@v3.0.2
              with:
                submodules: 'false'
                fetch-depth: 0
 
            - name: Bump version in AssemblyInfo.cs
              id: versioning
              uses: gittools/actions/gitversion/execute@v0.9.7
              with:
                additionalArguments: '/showConfig'
                useConfigFile: true
                updateAssemblyInfo: true
                updateAssemblyInfoFilename: src/Properties/AssemblyInfo.cs
                
            - name: Display GitVersion outputs
              run: |
                echo "Major: ${{ steps.gitversion.outputs.major }}"
                echo "Minor: ${{ steps.gitversion.outputs.minor }}"
                echo "Patch: ${{ steps.gitversion.outputs.patch }}"
                echo "PreReleaseTag: ${{ steps.gitversion.outputs.preReleaseTag }}"
                echo "PreReleaseTagWithDash: ${{ steps.gitversion.outputs.preReleaseTagWithDash }}"
                echo "PreReleaseLabel: ${{ steps.gitversion.outputs.preReleaseLabel }}"
                echo "PreReleaseNumber: ${{ steps.gitversion.outputs.preReleaseNumber }}"
                echo "WeightedPreReleaseNumber: ${{ steps.gitversion.outputs.weightedPreReleaseNumber }}"
                echo "BuildMetaData: ${{ steps.gitversion.outputs.buildMetaData }}"
                echo "BuildMetaDataPadded: ${{ steps.gitversion.outputs.buildMetaDataPadded }}"
                echo "FullBuildMetaData: ${{ steps.gitversion.outputs.fullBuildMetaData }}"
                echo "MajorMinorPatch: ${{ steps.gitversion.outputs.majorMinorPatch }}"
                echo "SemVer: ${{ steps.gitversion.outputs.semVer }}"
                echo "LegacySemVer: ${{ steps.gitversion.outputs.legacySemVer }}"
                echo "LegacySemVerPadded: ${{ steps.gitversion.outputs.legacySemVerPadded }}"
                echo "AssemblySemVer: ${{ steps.gitversion.outputs.assemblySemVer }}"
                echo "AssemblySemFileVer: ${{ steps.gitversion.outputs.assemblySemFileVer }}"
                echo "FullSemVer: ${{ steps.gitversion.outputs.fullSemVer }}"
                echo "InformationalVersion: ${{ steps.gitversion.outputs.informationalVersion }}"
                echo "BranchName: ${{ steps.gitversion.outputs.branchName }}"
                echo "EscapedBranchName: ${{ steps.gitversion.outputs.escapedBranchName }}"
                echo "Sha: ${{ steps.gitversion.outputs.sha }}"
                echo "ShortSha: ${{ steps.gitversion.outputs.shortSha }}"
                echo "NuGetVersionV2: ${{ steps.gitversion.outputs.nuGetVersionV2 }}"
                echo "NuGetVersion: ${{ steps.gitversion.outputs.nuGetVersion }}"
                echo "NuGetPreReleaseTagV2: ${{ steps.gitversion.outputs.nuGetPreReleaseTagV2 }}"
                echo "NuGetPreReleaseTag: ${{ steps.gitversion.outputs.nuGetPreReleaseTag }}"
                echo "VersionSourceSha: ${{ steps.gitversion.outputs.versionSourceSha }}"
                echo "CommitsSinceVersionSource: ${{ steps.gitversion.outputs.commitsSinceVersionSource }}"
                echo "CommitsSinceVersionSourcePadded: ${{ steps.gitversion.outputs.commitsSinceVersionSourcePadded }}"
                echo "UncommittedChanges: ${{ steps.gitversion.outputs.uncommittedChanges }}"
                echo "CommitDate: ${{ steps.gitversion.outputs.commitDate }}"
      
            - name: Bump version in manifest.json
              uses: jossef/action-set-json-field@v2
              with:
                file: src/manifest.json
                field: version
                value: ${{ steps.versioning.outputs.fullSemVer }}

            - name: Commit changes
              run: |
                git config --local user.email "action@github.com"
                git config --local user.name "GitHub Action"
                git add -A
                git commit -m "ðŸ”– bump version to ${{ steps.versioning.outputs.fullSemVer }}"
                
            - name: Push changes to manifest.json
              uses: ad-m/github-push-action@v0.6.0
              with:
                github_token: ${{ github.token }}
                branch: ${{ github.ref }}
                tags: ${{ env.REPO }}:latest,${{ env.REPO }}:v${{ steps.versioning.outputs.fullSemVer }}
                
            - name: Create Release
              if: ${{ !startsWith(github.ref, 'refs/tags/') }}
              uses: ncipollo/release-action@v1.10.0
              with:
                tag: v${{ steps.versioning.outputs.fullSemVer }}
                prerelease: true
